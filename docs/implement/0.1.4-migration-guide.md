# Database Migration Guide - Step by Step

**Táº¡o:** 2025-12-14  
**Task:** 0.1.4 - Database Schema Setup
**Má»¥c Ä‘Ã­ch:** HÆ°á»›ng dáº«n chi tiáº¿t cÃ¡ch cháº¡y database migration trong Supabase

---

## ğŸ“‹ BÆ°á»›c 1: Má»Ÿ Supabase Dashboard

1. **Truy cáº­p:** https://app.supabase.com
2. **ÄÄƒng nháº­p** vÃ o tÃ i khoáº£n cá»§a báº¡n
3. **Chá»n project:** `bio-affiliate` (hoáº·c tÃªn project báº¡n Ä‘Ã£ táº¡o)

---

## ğŸ“‹ BÆ°á»›c 2: Má»Ÿ SQL Editor

1. **TÃ¬m SQL Editor:**
   - á» sidebar bÃªn trÃ¡i, tÃ¬m icon **SQL Editor** (hoáº·c text "SQL Editor")
   - Click vÃ o Ä‘Ã³

2. **Táº¡o Query má»›i:**
   - Click nÃºt **"New Query"** (hoáº·c icon +)
   - Má»™t editor trá»‘ng sáº½ xuáº¥t hiá»‡n

---

## ğŸ“‹ BÆ°á»›c 3: Copy Migration SQL

1. **Má»Ÿ file migration:**
   - Trong project cá»§a báº¡n, má»Ÿ file: `docs/database/migration_001_initial_schema.sql`
   - File nÃ y chá»©a toÃ n bá»™ SQL Ä‘á»ƒ táº¡o tables, indexes, triggers, vÃ  RLS

2. **Copy toÃ n bá»™ ná»™i dung:**
   - Select All (Cmd/Ctrl + A)
   - Copy (Cmd/Ctrl + C)

---

## ğŸ“‹ BÆ°á»›c 4: Paste vÃ  Cháº¡y SQL

1. **Paste vÃ o SQL Editor:**
   - Click vÃ o editor trong Supabase
   - Paste (Cmd/Ctrl + V)

2. **Kiá»ƒm tra SQL:**
   - Scroll xuá»‘ng Ä‘á»ƒ xem toÃ n bá»™ SQL
   - Äáº£m báº£o cÃ³ Ä‘áº§y Ä‘á»§:
     - 5 CREATE TABLE statements
     - CREATE INDEX statements
     - CREATE FUNCTION statements
     - CREATE TRIGGER statements
     - ALTER TABLE ENABLE ROW LEVEL SECURITY
     - CREATE POLICY statements

3. **Cháº¡y SQL:**
   - Click nÃºt **"Run"** (hoáº·c nháº¥n `Cmd + Enter` / `Ctrl + Enter`)
   - Hoáº·c click icon â–¶ï¸ á»Ÿ gÃ³c trÃªn bÃªn pháº£i

---

## ğŸ“‹ BÆ°á»›c 5: Kiá»ƒm Tra Káº¿t Quáº£

### âœ… Náº¿u thÃ nh cÃ´ng:

Báº¡n sáº½ tháº¥y message:
```
Success. No rows returned
```

Hoáº·c:
```
Migration 001_initial_schema completed successfully!
Tables created: channels, categories, products, color_themes, bio_layouts
Indexes, triggers, and RLS policies have been set up.
```

### âŒ Náº¿u cÃ³ lá»—i:

**Lá»—i thÆ°á»ng gáº·p:**

1. **"relation already exists"**
   - **NguyÃªn nhÃ¢n:** Tables Ä‘Ã£ Ä‘Æ°á»£c táº¡o trÆ°á»›c Ä‘Ã³
   - **Giáº£i phÃ¡p:** 
     - Migration Ä‘Ã£ dÃ¹ng `CREATE TABLE IF NOT EXISTS`, nÃªn sáº½ skip
     - Hoáº·c drop tables vÃ  cháº¡y láº¡i (xem Troubleshooting)

2. **"permission denied"**
   - **NguyÃªn nhÃ¢n:** KhÃ´ng cÃ³ quyá»n táº¡o tables
   - **Giáº£i phÃ¡p:** Äáº£m báº£o báº¡n Ä‘ang dÃ¹ng account cÃ³ quyá»n admin

3. **"syntax error"**
   - **NguyÃªn nhÃ¢n:** SQL cÃ³ lá»—i syntax
   - **Giáº£i phÃ¡p:** Check láº¡i SQL Ä‘Ã£ copy Ä‘áº§y Ä‘á»§ chÆ°a

---

## ğŸ“‹ BÆ°á»›c 6: Verify Tables ÄÃ£ Táº¡o

1. **VÃ o Table Editor:**
   - Click **Table Editor** á»Ÿ sidebar bÃªn trÃ¡i
   - Hoáº·c click icon database

2. **Kiá»ƒm tra tables:**
   - Báº¡n sáº½ tháº¥y 5 tables:
     - âœ… `channels`
     - âœ… `categories`
     - âœ… `products`
     - âœ… `color_themes`
     - âœ… `bio_layouts`

3. **Kiá»ƒm tra structure:**
   - Click vÃ o tá»«ng table Ä‘á»ƒ xem columns
   - Verify cÃ³ Ä‘áº§y Ä‘á»§ columns nhÆ° trong schema

---

## ğŸ“‹ BÆ°á»›c 7: Test Connection

1. **Má»Ÿ test page:**
   - Restart dev server náº¿u Ä‘ang cháº¡y: `npm run dev`
   - Navigate to: `http://localhost:3000/test-connection.html`

2. **Test connection:**
   - Click **"Test Connection"**
   - âœ… BÃ¢y giá» sáº½ tháº¥y: `âœ… Supabase connection successful!`
   - âŒ KhÃ´ng cÃ²n lá»—i "table not found"

---

## ğŸ”§ Troubleshooting

### Drop Tables vÃ  Cháº¡y Láº¡i (Náº¿u cáº§n)

Náº¿u muá»‘n reset vÃ  cháº¡y láº¡i migration:

```sql
-- Drop tables (cháº¡y riÃªng, trÆ°á»›c khi cháº¡y migration)
DROP TABLE IF EXISTS bio_layouts CASCADE;
DROP TABLE IF EXISTS color_themes CASCADE;
DROP TABLE IF EXISTS products CASCADE;
DROP TABLE IF EXISTS categories CASCADE;
DROP TABLE IF EXISTS channels CASCADE;

-- Sau Ä‘Ã³ cháº¡y láº¡i migration_001_initial_schema.sql
```

### Verify Migration

Cháº¡y cÃ¡c queries sau Ä‘á»ƒ verify:

```sql
-- Check tables
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public' 
  AND table_name IN ('channels', 'categories', 'products', 'color_themes', 'bio_layouts')
ORDER BY table_name;

-- Check indexes
SELECT indexname, tablename 
FROM pg_indexes 
WHERE schemaname = 'public' 
  AND tablename IN ('channels', 'categories', 'products', 'color_themes', 'bio_layouts')
ORDER BY tablename, indexname;

-- Check triggers
SELECT trigger_name, event_object_table
FROM information_schema.triggers
WHERE event_object_schema = 'public'
  AND event_object_table IN ('channels', 'categories', 'products', 'color_themes', 'bio_layouts')
ORDER BY event_object_table, trigger_name;

-- Check RLS
SELECT tablename, rowsecurity 
FROM pg_tables 
WHERE schemaname = 'public' 
  AND tablename IN ('channels', 'categories', 'products', 'color_themes', 'bio_layouts')
ORDER BY tablename;
```

---

## ğŸ“¸ Screenshots Guide

### SQL Editor Location
```
Supabase Dashboard
â”œâ”€â”€ Sidebar (Left)
â”‚   â”œâ”€â”€ Dashboard
â”‚   â”œâ”€â”€ Table Editor
â”‚   â”œâ”€â”€ SQL Editor â† Click here
â”‚   â”œâ”€â”€ Storage
â”‚   â””â”€â”€ ...
```

### After Running Migration
```
SQL Editor
â”œâ”€â”€ Query executed successfully
â”œâ”€â”€ Message: "Migration 001_initial_schema completed successfully!"
â””â”€â”€ No errors
```

### Table Editor
```
Table Editor
â”œâ”€â”€ channels âœ…
â”œâ”€â”€ categories âœ…
â”œâ”€â”€ products âœ…
â”œâ”€â”€ color_themes âœ…
â””â”€â”€ bio_layouts âœ…
```

---

## âœ… Checklist

TrÆ°á»›c khi cháº¡y:
- [ ] ÄÃ£ login vÃ o Supabase Dashboard
- [ ] ÄÃ£ chá»n Ä‘Ãºng project
- [ ] ÄÃ£ má»Ÿ SQL Editor
- [ ] ÄÃ£ copy toÃ n bá»™ ná»™i dung tá»« `migration_001_initial_schema.sql`

Sau khi cháº¡y:
- [ ] SQL executed successfully (khÃ´ng cÃ³ lá»—i)
- [ ] 5 tables xuáº¥t hiá»‡n trong Table Editor
- [ ] Test connection thÃ nh cÃ´ng (khÃ´ng cÃ²n "table not found")

---

## ğŸ¯ Next Steps

Sau khi migration thÃ nh cÃ´ng:

1. âœ… **Task 0.1.4:** Database Schema Setup â†’ **Completed**
2. â­ï¸ **Task 0.1.5:** Supabase Storage Setup
   - Táº¡o bucket `product-images`
   - Xem: `docs/database/0.1.5-storage-setup.md`
3. â­ï¸ **Task 0.1.6:** Frontend Structure Setup
   - Táº¡o HTML files
   - Setup CSS variables
   - Create shared modules

---

## ğŸ“š Resources

- **Migration File:** `docs/database/migration_001_initial_schema.sql`
- **Setup Guide:** `docs/database/0.1.4-database-setup.md`
- **Database Schema:** `docs/analytics/analytics-db.md`
- **Supabase SQL Editor:** https://app.supabase.com/project/_/sql

---

**Káº¿t thÃºc Migration Guide**

