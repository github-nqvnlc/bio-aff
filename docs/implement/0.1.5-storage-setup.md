# Supabase Storage Setup Guide - Bio Affiliate

**Tạo:** 2025-12-14  
**Task:** 0.1.5 - Supabase Storage Setup
**Mục đích:** Hướng dẫn setup Supabase Storage cho product images

---

## Quick Start

1. **Mở Supabase Dashboard:**
   - Vào https://app.supabase.com
   - Chọn project của bạn

2. **Mở SQL Editor:**
   - Click vào **SQL Editor** ở sidebar
   - Click **New Query**

3. **Chạy Storage Setup:**
   - Copy toàn bộ nội dung file `docs/database/storage_setup.sql`
   - Paste vào SQL Editor
   - Click **Run** (hoặc nhấn `Cmd/Ctrl + Enter`)

4. **Verify:**
   - Vào **Storage** → Bạn sẽ thấy bucket `product-images`
   - Bucket sẽ là **Public** (có thể view images)

---

## Chi Tiết Setup

### 1. Storage Bucket

**Bucket Name:** `product-images`

**Configuration:**
- **Public:** ✅ `true` (images cần accessible từ frontend)
- **File Size Limit:** `5242880` bytes (5MB)
- **Allowed MIME Types:**
  - `image/jpeg`
  - `image/png`
  - `image/webp`
  - `image/gif`

### 2. Storage Structure

```
product-images/
├── {channel_id}/
│   ├── {timestamp}-{filename}.jpg
│   ├── {timestamp}-{filename}.png
│   └── ...
```

**Path Format:**
- `{channel_id}/{timestamp}-{filename}`
- Example: `1/1734216000-product-image.jpg`

### 3. Storage Policies

#### Public View (SELECT)
- ✅ Anyone can view images
- Policy: `Public can view product images`

#### Upload (INSERT)
- ✅ Authenticated users can upload
- ✅ Must have folder structure: `{channel_id}/filename`
- Policy: `Users can upload product images`

#### Update (UPDATE)
- ✅ Users can update their own images
- Policy: `Users can update own product images`

#### Delete (DELETE)
- ✅ Users can delete their own images
- Policy: `Users can delete own product images`

**Note:** Trong Phase 1 (mock auth), policies cho phép tất cả. Khi implement real auth, sẽ update để check channel ownership.

---

## Manual Setup (Alternative)

Nếu không muốn dùng SQL, có thể setup manual:

### 1. Create Bucket

1. Vào **Storage** trong Supabase Dashboard
2. Click **New bucket**
3. Điền thông tin:
   - **Name:** `product-images`
   - **Public bucket:** ✅ Checked
   - **File size limit:** `5242880` (5MB)
   - **Allowed MIME types:** `image/jpeg,image/png,image/webp,image/gif`
4. Click **Create bucket**

### 2. Setup Policies

1. Click vào bucket `product-images`
2. Vào tab **Policies**
3. Tạo policies tương tự như trong `storage_setup.sql`

---

## Usage trong Code

### Upload Image

```javascript
import { uploadImage } from './shared/image-handler.js';

// Upload image
const result = await uploadImage(file, channelId);
console.log(result.url); // Public URL
```

### Delete Image

```javascript
import { deleteImage } from './shared/image-handler.js';

// Delete image
await deleteImage(filePath);
```

### Get Public URL

```javascript
import { getImageUrl } from './shared/image-handler.js';

// Get URL
const url = getImageUrl(filePath);
```

Xem chi tiết: `src/shared/image-handler.js`

---

## Troubleshooting

### ❌ "Bucket not found"
- **Nguyên nhân:** Bucket chưa được tạo
- **Giải pháp:** Chạy `storage_setup.sql` hoặc tạo bucket manual

### ❌ "new row violates row-level security policy"
- **Nguyên nhân:** Storage policies chưa được setup
- **Giải pháp:** Chạy `storage_setup.sql` để tạo policies

### ❌ "File size exceeds limit"
- **Nguyên nhân:** File > 5MB
- **Giải pháp:** Compress image hoặc tăng limit trong bucket settings

### ❌ "Invalid MIME type"
- **Nguyên nhân:** File không phải image (JPEG, PNG, WebP, GIF)
- **Giải pháp:** Convert image sang format được support

---

## Verification

### Check Bucket
```sql
SELECT * FROM storage.buckets WHERE id = 'product-images';
```

### Check Policies
```sql
SELECT * FROM pg_policies 
WHERE schemaname = 'storage' 
  AND tablename = 'objects'
  AND policyname LIKE '%product%';
```

### Test Upload (Manual)
1. Vào **Storage** → `product-images`
2. Click **Upload file**
3. Chọn một image file
4. Upload vào folder `test/` (tạm thời)
5. ✅ Nếu upload thành công → Storage setup OK!

---

## Next Steps

Sau khi storage setup thành công:

1. ✅ **Task 0.1.5:** Supabase Storage Setup (Current)
2. ⏭️ **Task 0.1.6:** Frontend Structure Setup
   - Tạo HTML files
   - Setup CSS variables
   - Create shared modules

---

## Resources

- **Storage Setup SQL:** `docs/database/storage_setup.sql`
- **Image Handler:** `src/shared/image-handler.js`
- **Database Schema Docs:** `docs/analytics/analytics-db.md`
- **Supabase Storage Docs:** https://supabase.com/docs/guides/storage

---

**Kết thúc Storage Setup Guide**

