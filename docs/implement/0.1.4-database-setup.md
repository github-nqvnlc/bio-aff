# Database Setup Guide - Bio Affiliate

**Tạo:** 2025-12-14  
**Task:** 0.1.4 - Database Schema Setup
**Mục đích:** Hướng dẫn setup database schema trong Supabase

---

## Quick Start

1. **Mở Supabase Dashboard:**
   - Vào https://app.supabase.com
   - Chọn project của bạn

2. **Mở SQL Editor:**
   - Click vào **SQL Editor** ở sidebar bên trái
   - Click **New Query**

3. **Chạy Migration:**
   - Copy toàn bộ nội dung file `docs/database/migration_001_initial_schema.sql`
   - Paste vào SQL Editor
   - Click **Run** (hoặc nhấn `Cmd/Ctrl + Enter`)

4. **Verify:**
   - Vào **Table Editor** → Bạn sẽ thấy 5 tables:
     - ✅ `channels`
     - ✅ `categories`
     - ✅ `products`
     - ✅ `color_themes`
     - ✅ `bio_layouts`

**Chi tiết từng bước:** Xem `docs/database/0.1.4-migration-guide.md`

---

## Chi Tiết Migration

### 1. Tables Created

#### `channels`
- Lưu thông tin TikTok channel/user
- Primary key: `id`
- Unique: `tiktok_id`

#### `categories`
- Danh mục sản phẩm cho mỗi channel
- Foreign key: `channel_id` → `channels(id)`
- Cascade delete khi xóa channel

#### `products`
- Sản phẩm affiliate
- Foreign keys: `channel_id`, `category_id`
- Status: `active` hoặc `inactive`
- Tags: Array TEXT[]

#### `color_themes`
- Cấu hình màu sắc
- Foreign key: `channel_id`
- Colors: JSONB với 5 màu (primary, secondary, background, text, accent)
- Chỉ 1 theme active per channel (enforced by trigger)

#### `bio_layouts`
- Cấu hình layout drag-drop
- Foreign key: `channel_id` (UNIQUE - 1 layout per channel)
- Foreign key: `theme_id` → `color_themes(id)` (optional)
- Blocks: JSONB array

---

### 2. Indexes Created

**Performance indexes:**
- Foreign key indexes (channel_id, category_id)
- Composite indexes cho sorting (order_index)
- Partial indexes cho active/published records
- GIN indexes cho JSONB và arrays

**Total:** 15 indexes

---

### 3. Triggers Created

#### Auto-update `updated_at`
- Tự động cập nhật `updated_at` khi record được update
- Áp dụng cho tất cả 5 tables

#### Single Active Theme
- Đảm bảo chỉ 1 theme `is_active = TRUE` per channel
- Tự động deactivate themes khác khi activate theme mới

#### Set `published_at`
- Tự động set `published_at = NOW()` khi `is_published` chuyển từ FALSE → TRUE

---

### 4. Row Level Security (RLS)

**RLS Enabled:** ✅ Tất cả 5 tables

**Policies:**
- **SELECT:** Public có thể đọc (cho public bio pages)
- **INSERT/UPDATE/DELETE:** Sẽ được restrict bởi auth trong application layer
- **Products:** Chỉ hiển thị `status = 'active'` cho public
- **Layouts:** Chỉ hiển thị `is_published = TRUE` cho public

**Note:** Trong Phase 1 (mock auth), policies cho phép tất cả. Khi implement real auth, sẽ update policies để check user ownership.

---

## Verification

### Check Tables
```sql
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public' 
  AND table_name IN ('channels', 'categories', 'products', 'color_themes', 'bio_layouts')
ORDER BY table_name;
```

### Check Indexes
```sql
SELECT indexname, tablename 
FROM pg_indexes 
WHERE schemaname = 'public' 
  AND tablename IN ('channels', 'categories', 'products', 'color_themes', 'bio_layouts')
ORDER BY tablename, indexname;
```

### Check Triggers
```sql
SELECT trigger_name, event_object_table, action_statement
FROM information_schema.triggers
WHERE event_object_schema = 'public'
  AND event_object_table IN ('channels', 'categories', 'products', 'color_themes', 'bio_layouts')
ORDER BY event_object_table, trigger_name;
```

### Check RLS
```sql
SELECT tablename, rowsecurity 
FROM pg_tables 
WHERE schemaname = 'public' 
  AND tablename IN ('channels', 'categories', 'products', 'color_themes', 'bio_layouts')
ORDER BY tablename;
```

---

## Troubleshooting

### ❌ "relation already exists"
- **Nguyên nhân:** Tables đã được tạo trước đó
- **Giải pháp:** 
  - Dùng `CREATE TABLE IF NOT EXISTS` (đã có trong migration)
  - Hoặc drop tables và chạy lại:
    ```sql
    DROP TABLE IF EXISTS bio_layouts CASCADE;
    DROP TABLE IF EXISTS color_themes CASCADE;
    DROP TABLE IF EXISTS products CASCADE;
    DROP TABLE IF EXISTS categories CASCADE;
    DROP TABLE IF EXISTS channels CASCADE;
    ```

### ❌ "permission denied"
- **Nguyên nhân:** Không có quyền tạo tables
- **Giải pháp:** Đảm bảo bạn đang dùng account có quyền admin trong Supabase project

### ❌ "foreign key constraint fails"
- **Nguyên nhân:** Thứ tự tạo tables sai
- **Giải pháp:** Migration đã handle đúng thứ tự (channels → categories/products/themes → layouts)

---

## Next Steps

Sau khi migration thành công:

1. ✅ **Task 0.1.4:** Database Schema Setup (Current)
2. ⏭️ **Task 0.1.5:** Supabase Storage Setup
   - Tạo bucket `product-images`
   - Setup storage policies
   - Xem: `docs/database/0.1.5-storage-setup.md`

---

## Resources

- **Migration File:** `docs/database/migration_001_initial_schema.sql`
- **Migration Guide:** `docs/database/0.1.4-migration-guide.md`
- **Database Schema Docs:** `docs/analytics/analytics-db.md`
- **Supabase SQL Editor:** https://app.supabase.com/project/_/sql

---

**Kết thúc Database Setup Guide**

